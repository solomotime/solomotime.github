
<!DOCTYPE html>
<!--[if lt IE 7 ]><html dir="ltr" lang="en-US" class="no-js ie ie6 lte7 lte8 lte9"><![endif]-->
<!--[if IE 7 ]><html dir="ltr" lang="en-US" class="no-js ie ie7 lte7 lte8 lte9"><![endif]-->
<!--[if IE 8 ]><html dir="ltr" lang="en-US" class="no-js ie ie8 lte8 lte9"><![endif]-->
<!--[if IE 9 ]><html dir="ltr" lang="en-US" class="no-js ie ie9 lte9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--><html dir="ltr" lang="en-US" class="no-js"><!--<![endif]-->
    <head>
        <meta charset="UTF-8" />
  <title>From bits to waves - The inner workings of an ethernet controller - YOURAN RUOMING</title>
  <meta name="author" content="Shawn Cheng">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


  
  <meta name="description" content="Understand the internals of an Ethernet driver and how it interfaces with the linkx kernel on one side and the network on the other side">
  <meta name="keywords" content="Linux network driver, eepro100, Intel 82559, 8255x, Linux Ethernet Driver internals, Deepak Kandepet, Kandepet">

  
  <link rel="canonical" href="http://solomo.github.com/blog/2012/05/09/from-bits-to-waves-the-inner-workings-of-an-ethernet-controller">

        <link rel="shortcut icon" href="/images/favicon.ico" />
        <link rel="profile" href="http://gmpg.org/xfn/11" />
        <!--<link rel="stylesheet" href="http://hackerlabs.co/wp-content/themes/svbtle/style.css" />-->
        <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
        <link rel="pingback" href="http://hackerlabs.co/xmlrpc.php" />
        <link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css' />
<link rel="alternate" type="application/rss+xml" title="Hacker Labs &raquo; Feed" href="http://hackerlabs.co/feed/" />
<link rel="alternate" type="application/rss+xml" title="Hacker Labs &raquo; Comments Feed" href="http://hackerlabs.co/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Hacker Labs &raquo; FrontPage Comments Feed" href="http://hackerlabs.co/frontpage/feed/" />
<!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js" onload="window.ieshiv=true;"></script>
    <script>!window.ieshiv && document.write(unescape('%3Cscript src="http://hackerlabs.co/wp-content/themes/svbtle/js/ieshiv.js"%3E%3C/script%3E'))</script>
<![endif]-->
<!--<link rel='stylesheet' id='socialfit-css'  href='http://hackerlabs.co/wp-content/plugins/socialfit/css/socialfit.css?ver=3.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='reclinks-css'  href='http://hackerlabs.co/wp-content/plugins/recommended-links/reclinks-styles.css?ver=3.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='codecolorer-css'  href='http://hackerlabs.co/wp-content/plugins/codecolorer/codecolorer.css?ver=0.9.9' type='text/css' media='screen' />
<script type='text/javascript' src='http://hackerlabs.co/wp-content/plugins/socialfit/js/socialfit.js?ver=3.3.1'></script>
<script type='text/javascript' src='http://hackerlabs.co/wp-includes/js/comment-reply.js?ver=20090102'></script>
<script type='text/javascript' src='http://hackerlabs.co/wp-content/plugins/rotating-posts/rotating-posts.js?ver=1.0'></script>
<script type='text/javascript' src='http://hackerlabs.co/wp-content/plugins/snazzy-archives/snazzy-archives.js?ver=3.3.1'></script>
-->
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://hackerlabs.co/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://hackerlabs.co/wp-includes/wlwmanifest.xml" />
<link rel='prev' title='Archive' href='http://hackerlabs.co/archive/' />
<link rel='next' title='Blog' href='http://hackerlabs.co/blog/' />

<!-- Google Fonts -->

<!--
<link href='http://fonts.googleapis.com/css?family=Arvo:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css' /><link href='http://fonts.googleapis.com/css?family=Cardo' rel='stylesheet' type='text/css' />

<style type="text/css" media="screen">

h1 { font-family: 'Arvo', arial, serif; }

h2 { font-family: 'Arvo', arial, serif; }

h3 { font-family: 'Arvo', arial, serif; }

h4 { font-family: 'Arvo', arial, serif; }

h5 { font-family: 'Arvo', arial, serif; }

h6 { font-family: 'Arvo', arial, serif; }
-->


</style>

<!-- fonts delivered by Wordpress Google Fonts, a plugin by Adrian3.com -->



<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <link href="/atom.xml" rel="alternate" title="YOURAN RUOMING" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src='//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js' type='text/javascript'></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'tianyu6911']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



    </head>



    <body class="home page page-id-102 page-template page-template-front-page-template-php">
    
    <div id="wrap">
        
        <header role="banner"><!--<hgroup>
<h1><a href="/">YOURAN RUOMING</a></h1>

</hgroup>-->

<figure id="user_logo">
<a href="/">
    <div class="logo">&nbsp;</div>
</a>
</figure>

<div class="header-logo">
    <h1><a href="/" title="YOURAN RUOMING" rel="home">YOURAN RUOMING</a></h1>
    <p></p>
    <div class="social right">
        <a class="twitter" href="http://twitter.com/yfccb" title="Twitter : HackerLabs">Twitter</a>
        <a class="github" href="https://github.com/yfccb" title="GitHub : HackerLabs">GitHub</a>
        <a class="moreinfo" href="/about/" title="More Info">More Info</a>
        <a class="contact" href="/contact" title="Contact Youran">@</a>
        <a class="rss" href="http://feeds.feedburner.com/youranruoming" title="RSS">RSS</a>
    </div>

</div>

 </header>
        <section id="content" role="main">
        <article id="post-47" class="post-47 post type-post status-publish format-standard hentry category-digital-self category-entropy category-information">
            

<article id="post-47" class="post-47 post type-post status-publish format-standard hentry category-digital-self category-entropy category-information">
  <div class="entry-meta" >
    <!--<span class="entry-date">August 4 2011</span>-->
    <div class="search alignright">
        <a class="search" href="/search/" title="search">Search</a>
    </div>
    








  



<span class="entry-date"  datetime="2012-05-09T06:57:00+08:00" pubdate data-updated="true">May 9<span>th</span>, 2012</span>
    
</div>

<h1 class="entry-title">From Bits to Waves - the Inner Workings of an Ethernet Controller</h1>

<div class="entry-content"><p>About 10 years ago, I started hacking the Linux kernel. My interest was the TCP/IP stack and specifically the workings
of an Ethernet controller and its Linux driver. I picked one of the most widely used Ethernet controllers at that time,
the <a href="http://www.intel.com/design/network/products/lan/controllers/82559.htm" title="Intel 82559 10/100 Fast Ethernet Controller">Intel 82559 10/100 Fast Ethernet Controller</a> and one of its open-source drivers, the eepro100. My original aim was to
write a book, but after 10 years, I think its time I shared what I learnt.</p>

<p>In this article I want to talk about how the eepro100 driver interfaces with the Intel 82559 chipset and how the 82559
converts the packets sent by the driver to signals transmitted over physical wires. So, without further ado:</p>

<h2>The mighty 82559</h2>

<p>The 82559 is an Intel ethernet chipset. It supports 10/100 Mbps full duplex data communication over a pair of wires.
This is a high level block diagram of the 82559.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559-Block-Diagram.png" title="Block Diagram of 82559" ><span class='caption-text'>Block Diagram of 82559</span></span></p>

<p>The most important subsystems of 82559 are:</p>

<ul>
<li>A parallel subsystem (shown in green).</li>
<li>A FIFO subsystem (shown in red).</li>
<li>The 10/100 Mbps Carrier Sense Multiple Access with Collision Detect (CSMA/CD) unit (shown in blue).</li>
<li>The 10/100 Mbps physical layer (PHY) unit (shown in black).</li>
</ul>


<h3>The parallel subsystem</h3>

<p>The parallel subsystem is responsible for interfacing the chipset with the motherboard via the PCI bus. It also controls
and executes all the chipset&#8217;s functions via a Micro-Machine.</p>

<p>As a PCI device, 82559 can operate in two modes:</p>

<ul>
<li>As a PCI target (slave mode). In slave mode, 82559 is completely controlled by the host CPU. The CPU initiates all
transmit and receive actions when 82559 is in slave mode.</li>
<li>For processing the transmit and receive frames, the 82559 operates as a master on the PCI bus. It needs no help from
the host CPU to read/write memory or other resources and can work independently.</li>
</ul>


<p>The <strong>micromachine </strong> is an embedded processing unit. Instructions for carrying out all the 82559&#8217;s functions are
embedded in a microcode ROM within the micromachine. The micromachine is divided into two units:</p>

<ul>
<li><strong>Receive Unit (RU)</strong></li>
<li><strong>Command Unit (CU)</strong>. The CU is also the transmit unit.</li>
</ul>


<p>These two units operate independently and concurrently. Control is switched between the two units according to the
microcode instruction flow. The independence of the Receive and Command units in the micromachine allows the 82559 to
execute commands and receive incoming frames simultaneously, with no real-time CPU intervention.</p>

<p>The 82559 also interfaces with an external Flash memory and an external serial EEPROM. The <strong>Flash memory</strong> may be used
for remote boot functions, network statistics, diagnostics and management functions. The <strong>EEPROM</strong> is used to store
relevant information for a LAN connection such as node address (MAC Address), as well as board manufacturing and
configuration information.</p>

<h3>FIFO Subsystem</h3>

<p>The 82559 FIFO (First In, First Out) subsystem consists of a 3 Kbyte transmit FIFO and 3 Kbyte receive FIFO. Each FIFO
is unidirectional and independent of the other. The FIFO subsystem serves as the interface between the 82559 parallel
side and the serial CSMA/CD unit. It provides a temporary buffer storage area for frames as they are either being
received or transmitted by the 82559. Transmit frames can be queued within the transmit FIFO, allowing back-to-back
transmission within the <a title="Interframe gap" href="http://en.wikipedia.org/wiki/Interframe_gap">minimum Interframe
Spacing (IFS)</a>. Transmissions resulting in errors (collision detection or data underruns) are re-transmitted directly
from the 82559 FIFO eliminating the need to re-access this data from the host system.</p>

<h3>CSMA/CD unit</h3>

<p>The CSMA/CD unit of the 82559 allows it to be connected to either a 10 or 100 Mbps Ethernet network. The CSMA/CD unit
performs all of the functions of the 802.3 protocol such as <a title="CSMA/CD"
href="http://en.wikipedia.org/wiki/CSMA/CD">frame formatting, frame stripping, collision handling, deferral to link
traffic</a>, etc. The CSMA/CD unit can also be placed in a full duplex mode which allows simultaneous transmission and
reception of frames.</p>

<h3>Physical Unit (PHY)</h3>

<p>The <a title="PHY Layer" href="http://en.wikipedia.org/wiki/PHY_%28chip%29">Physical Layer (PHY)</a> unit of the 82559
is where the digital data is converted to a signal that can propagate over the network wires. To make the actual
connection to the network, additional components such as transformers anmpedances re needed. This additional components
are external to 82559.</p>

<h3>Accessing 82559 as a PCI device</h3>

<p>A PCI peripheral boards can be accessed using three different address spaces: memory locations, I/O ports, and
configuration registers.</p>

<ul>
<li>The memory and I/O port address space is shared by all devices on a PCI bus (i.e., when you access a memory location,
all the devices see the bus cycle at the same time). A driver can read memory and I/O regions via inb, readb, and so
forth.</li>
<li>The configuration space, on the other hand, exploits geographical addressing. i.e. each PCI slot is uniquely addressed
(by a 16 bit address), thus eliminating collisions when configuring devices. To access the configuration space of
82559, the full configuration address (bus, slot, function, offset) is written to an I/O port (for 82559, CONFIG_ADDRESS
= 0xCF8) and then the 32-bit word at this address can be read or written through another location (for 82559,
CONFIG_DATA = 0xCFC ).</li>
</ul>


<p>After a PCI device is powered on, the hardware remains in an inactive state and the will only respond to configuration
transactions. This is because, at power on, the device does not have its memory and I/O ports mapped into the computer&#8217;s
address space. Every other device-specific feature, such as interrupt reporting, is disabled as well.</p>

<p>After power on, the BIOS must first scan the PCI bus to determine what PCI device exists and what configuration
requirements they have. In order to facilitate this process, all PCI devices, including 82559, must implement a base set
of configuration registers as defined by the PCe standard registers defined by 82559 is shown in the figure below.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559ConfigSpace.jpg" width="82559" title="Config Space" ><span class='caption-text'>Config Space</span></span></p>

<p>The BIOS reads the Vendor ID, Device ID and Class registers in order to detect the device and its type. 82559 being an
Intel device, returns a hard-coded 8086H for Device ID.</p>

<h3>Memory &amp; IO Mapping the 82559 device.</h3>

<p>Having detected 82559, the BIOS then accesses 82559&#8217;s base address configuration registers to determine how many blocks
of memory and/or IO space the device requires. Ese Address Register (BAR) is 32 bits wide and there can be upto 6 BARs
per device. 82559 defines 3 types of BARs, the Control/Status Registers (CSR), Flash, and Expansion ROM as shown in
figure above.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/BAR.jpg" title="Base Address Register (BAR)" ><span class='caption-text'>Base Address Register (BAR)</span></span></p>

<p>Bit zero in all base registers is read only and is used to determine whether the register maps into memory (0) or I/O
space (1).ach bove shows the layout of a BAR for memory mapping.</p>

<p>The 82559 contains three BARs, two requesting memory mapped resources and one requesting IO mapping.
specification.ontrol and Status Register (CSR) is both Memory Mapped (CSR Memory mapped base address register: 10H) and
IO mapped (CSR I/O Mapped Base Address Register: 14H) to anywhere within the 32- bit memory address space. It is up to
the driver (eepro100) to determine which BAR (I/O or Memory) to use to access the 82559 Control/Status registers. The
size of the memory space is 4Kb and that of I/O space is 32 bytes. The 82559 also requires one BAR (Flash Memory Mapped
Base Address Register: 18H) to map accesses to an optional FLASH memory.</p>

<p>After determining the types of mapping and amount of memory/IO space requested from the BARs, BIOS maps the I/O and
memory controllers into available memory locations and proceeds with system boot.</p>

<h3>The Kernel PCI Initialization</h3>

<p>As described above, for Intel based systems the system BIOS which ran at boot time has already fully configured the PCI
system. This leaves Linux kernel with little to do other than remap that configuration.</p>

<p>The PCI device driver (pci.c) starts by scanning PCI Buses and creates a pci_dev for every device (including PCI-to-PCI
bridges) and pci_bus for every bus it finds. These structures are linked together into a tree that mimics the actual PCI
topology.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/PCITree.jpg" title="PCI Tree" ><span class='caption-text'>PCI Tree</span></span></p>

<p>At this stage, the BIOS has recognized the 82559 and configured its PCI configuration space assigning it unique memory
and IO space and the Linux kernel has created a pci_dev data structure defining 82559.</p>

<h3>82559 PCI Initialization</h3>

<p>When the eepro100 driver module is loaded into the kernel, the driver registers itself as a PCI driver by calling
<em>pci_register_driver()</em>. Implicitly passed to <em>pci_register_driver()</em> is a table of all supported devices
(<em>eepro100_pci_tbl</em>).
over serves a range of Intel chipsets: 82557, 82558, 82559, 82801, etc.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">eepro100_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82557</span><span class="p">,</span>
</span><span class='line'>        <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82559ER</span><span class="p">,</span>
</span><span class='line'>        <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_7</span><span class="p">,</span>
</span><span class='line'>        <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1029</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1030</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1031</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1032</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1033</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1034</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1035</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1036</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1037</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1038</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1039</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x103A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x103B</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x103C</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x103D</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x103E</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1050</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1059</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1227</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1228</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x2449</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x2459</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x245D</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x5200</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x5201</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="mi">0</span><span class="p">,}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">eepro100_pci_tbl</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>After registering the driver, <em>pci_register_driver()</em> probes [<em>pci_device_probe()</em>] the PCI device tree
for all unclaimed PCI devices. Chances are that one of those devices could be an eepro100 compatible device. When an
unclaimed device is found, <em>pci_bus_match()</em> and <em>pci_match_device()</em> are called to check if this
unclaimed device is an eepro100 compliant PCI device.</p>

<p><em>pci_match_device()</em> checks if the PCI_VENDOR_ID, PCI_DEVICE_ID, PCI_SUBVENDOR_ID, PCI_SUBDEVICE_ID from the
<em>eepro100_pci_tbl</em> and the device configure header values match (see 82559 configuration space figure above). If
a match is found, eepro100&#8217;s probe function, <em>eepro100_init_one()</em>, is called to reset/probe the new device.
After the probe is complete, the device is marked as claimed by eepro100.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eepro100_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
</span><span class='line'>        <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">pci_bar</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">acpi_idle_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pm</span><span class="p">;</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span> <span class="cm">/* = 0 */</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pci_base</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef MODULE</span>
</span><span class='line'>    <span class="cm">/* when built-in, we only print version if device is found */</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">int</span> <span class="n">did_version</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">did_version</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* save power state before pci_enable_device overwrites it */</span>
</span><span class='line'>    <span class="n">pm</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PM</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">u16</span> <span class="n">pwr_command</span><span class="p">;</span>
</span><span class='line'>        <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">pwr_command</span><span class="p">);</span>
</span><span class='line'>        <span class="n">acpi_idle_state</span> <span class="o">=</span> <span class="n">pwr_command</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">PCI_PM_CTRL_STATE_MASK</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">err_out_free_mmio_region</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span class='line'>            <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;eepro100&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;eepro100: cannot reserve I/O ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">err_out_none</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span class='line'>            <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s">&quot;eepro100&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;eepro100: cannot reserve MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">err_out_free_pio_region</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">irq</span><span class="p">;</span>
</span><span class='line'>    <span class="n">pci_bar</span> <span class="o">=</span> <span class="n">use_io</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">pci_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_bar</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">NETIF_MSG_PROBE</span><span class="p">)</span>
</span><span class='line'>        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Found Intel i82557 PCI Speedo at %#lx, IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">pci_base</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_bar</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;eepro100: cannot remap IO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">err_out_free_mmio_region</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">speedo_found1</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards_found</span><span class="p">,</span> <span class="n">acpi_idle_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">err_out_iounmap:</span> <span class="p">;</span>
</span><span class='line'>    <span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
</span><span class='line'><span class="nl">err_out_free_mmio_region:</span>
</span><span class='line'>    <span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span><span class='line'><span class="nl">err_out_free_pio_region:</span>
</span><span class='line'>    <span class="n">release_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'><span class="nl">err_out_none:</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>pci_find_capability()</em>: Every device that supports PCI power management, including 82559, has an 8 byte
capability field in its PCI configuration space (See address DCh - Eoh in the figure above). This field is used to
describe and control the standard PCI power management features. The PCI PM spec defines 4 operating states for devices,
D0 - D3. The higher the number, less power the device consumes but longer is the latency for the device to return to the
operational state (D0). 82559 supports all 4 power states. <em>pci_enable_device()</em> (via
<em>pci_set_power_state()</em>) activates 82559 by switching it to the D0 state.</p>

<p><em>pci_set_master()</em>: If the device has bus mastering capability, during bootup the BIOS can read two of its
configuration registers (Minimum Grant register: Min_Gnt and Maximum Latency register: Max_Lat, see configuration
registers in the above figure) to determine how quickly it requires access to the PCI bus when it asserts REQ# pin and
the average duration of its transfer when it has acquired ownership of the bus. The BIOS can utilize this information to
program the bus master&#8217;s latency timer register and the PCI bus arbiter to provide the optimum PCI bus utilization. For
82559, the default value of Minimum Grant Register is 08H and Maximum Latency Register is 18H. pci_set_master() is
called to enable 82559 to act as a bus master.</p>

<p>During boot, the BIOS had allocated a range of unique memory and IO regions for accessing 82559&#8217;s configuration space.
For the driver to use these regions, they have to be reserved and locked in the kernel by marking those regions as BUSY
(to prevent other drivers from accessing these same regions). <em>eepro100_init_one()</em> locks the PCI BIOS assigned
IO port regions using <em>request_region()</em> (cat /proc/ioports to see a list of all locked IO ports). Similarly to
reserve memory mapped regions <em>request_mem_region()</em> is called. This is done for all the 3 three regions pointed
to by the 3 active 82559 BARs.</p>

<p>The 82559 is now physically enabled and is ready to start receiving and transmitting ethernet frames. The driver now
prepares the kernel to start using this device for network access via <em>speedo_found1()</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">speedo_found1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
</span><span class='line'>        <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acpi_idle_state</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">speedo_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">product</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">option</span><span class="p">;</span>
</span><span class='line'>    <span class="n">u16</span> <span class="n">eeprom</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">tx_ring_space</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dma_addr_t</span> <span class="n">tx_ring_dma</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">size</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">speedo_stats</span><span class="p">);</span>
</span><span class='line'>    <span class="n">tx_ring_space</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">tx_ring_space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">speedo_private</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;eepro100: Could not allocate ethernet device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tx_ring_space</span><span class="p">,</span> <span class="n">tx_ring_dma</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">SET_MODULE_OWNER</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mem_start</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">option</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mem_start</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span>  <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span>  <span class="n">options</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">option</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">card_idx</span><span class="p">];</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">option</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">rtnl_lock</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">err_free_unlock</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Read the station address EEPROM before doing the reset.</span>
</span><span class='line'><span class="cm">    Nominally his should even be done before accepting the device, but</span>
</span><span class='line'><span class="cm">    then we wouldn&#39;t have a device name with which to report the error.</span>
</span><span class='line'><span class="cm">    The size test is for 6 bit vs. 8 bit address serial EEPROMs.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">read_cmd</span><span class="p">,</span> <span class="n">ee_size</span><span class="p">;</span>
</span><span class='line'>        <span class="n">u16</span> <span class="n">sum</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Use IO only to avoid postponed writes and satisfy EEPROM timing</span>
</span><span class='line'><span class="cm">        requirements. */</span>
</span><span class='line'>        <span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iobase</span><span class="p">)</span>
</span><span class='line'>            <span class="k">goto</span> <span class="n">err_free_unlock</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">((</span><span class="n">do_eeprom_cmd</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">EE_READ_CMD</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0xffe0000</span><span class="p">)</span>
</span><span class='line'>            <span class="o">==</span> <span class="mh">0xffe0000</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ee_size</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
</span><span class='line'>            <span class="n">read_cmd</span> <span class="o">=</span> <span class="n">EE_READ_CMD</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">24</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ee_size</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
</span><span class='line'>            <span class="n">read_cmd</span> <span class="o">=</span> <span class="n">EE_READ_CMD</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">22</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">ee_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">u16</span> <span class="n">value</span> <span class="o">=</span> <span class="n">do_eeprom_cmd</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">read_cmd</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">27</span><span class="p">);</span>
</span><span class='line'>            <span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>            <span class="n">sum</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>                 <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>                <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">sum</span> <span class="o">!=</span> <span class="mh">0xBABA</span><span class="p">)</span>
</span><span class='line'>            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Invalid EEPROM checksum %#4.4x, &quot;</span>
</span><span class='line'>                <span class="s">&quot;check settings before activating this device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* Don&#39;t  unregister_netdev(dev);  as the EEPro may actually be</span>
</span><span class='line'><span class="cm">        usable, especially if the MAC address is set later.</span>
</span><span class='line'><span class="cm">        On the other hand, it may be unusable if MDI data is corrupted. */</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Reset the chip: stop Tx and Rx processes and clear counters.</span>
</span><span class='line'><span class="cm">    This takes less than 10usec and will easily finish before the next</span>
</span><span class='line'><span class="cm">    action. */</span>
</span><span class='line'>    <span class="n">iowrite32</span><span class="p">(</span><span class="n">PortReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SCBPort</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SCBPort</span><span class="p">);</span>
</span><span class='line'>    <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x0100</span><span class="p">)</span>
</span><span class='line'>        <span class="n">product</span> <span class="o">=</span> <span class="s">&quot;OEM i82557/i82558 10/100 Ethernet&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">product</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s, &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">,</span> <span class="n">product</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%2.2X:&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%2.2X, &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">irq</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* we must initialize this early, for mdio_{read,write} */</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if 1 || defined(kernel_bloat)</span>
</span><span class='line'>    <span class="cm">/* OK, this is pure kernel bloat.  I don&#39;t like it when other drivers</span>
</span><span class='line'><span class="cm">    waste non-pageable kernel space to emit similar messages, but I need</span>
</span><span class='line'><span class="cm">    them for bug reports. */</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">connectors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot; RJ45&quot;</span><span class="p">,</span> <span class="s">&quot; BNC&quot;</span><span class="p">,</span> <span class="s">&quot; AUI&quot;</span><span class="p">,</span> <span class="s">&quot; MII&quot;</span><span class="p">};</span>
</span><span class='line'>        <span class="cm">/* The self-test results must be paragraph aligned. */</span>
</span><span class='line'>        <span class="k">volatile</span> <span class="n">s32</span> <span class="o">*</span><span class="n">self_test_results</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">boguscnt</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>    <span class="cm">/* Timeout for set-test. */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">((</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span>
</span><span class='line'>            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Receiver lock-up bug exists -- enabling&quot;</span>
</span><span class='line'>                <span class="s">&quot; work-around.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Board assembly %4.4x%2.2x-%3.3d, Physical&quot;</span>
</span><span class='line'>            <span class="s">&quot; connectors present:&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">eeprom</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="mi">8</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="mi">15</span><span class="p">],</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x1f</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x0700</span><span class="p">)</span>
</span><span class='line'>            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    Secondary interface chip %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">phys</span><span class="p">[(</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="mi">7</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(((</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="n">DP83840</span>
</span><span class='line'>            <span class="o">||</span>  <span class="p">((</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="n">DP83840A</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">mdi_reg23</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0422</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">congenb</span><span class="p">)</span>
</span><span class='line'>            <span class="n">mdi_reg23</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>
</span><span class='line'>            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;  DP83840 specific setup, setting register 23 to %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">mdi_reg23</span><span class="p">);</span>
</span><span class='line'>            <span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">mdi_reg23</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x70</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Forcing %dMbs %s-duplex operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x20</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">),</span>
</span><span class='line'>                <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">));</span>
</span><span class='line'>            <span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
</span><span class='line'>                    <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>     <span class="cm">/* 100mbps? */</span>
</span><span class='line'>                    <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span> <span class="cm">/* Full duplex? */</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Perform a system self-test. */</span>
</span><span class='line'>        <span class="n">self_test_results</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="o">*</span><span class="p">)</span> <span class="p">((((</span><span class="kt">long</span><span class="p">)</span> <span class="n">tx_ring_space</span><span class="p">)</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">);</span>
</span><span class='line'>        <span class="n">self_test_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">self_test_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">iowrite32</span><span class="p">(</span><span class="n">tx_ring_dma</span> <span class="o">|</span> <span class="n">PortSelfTest</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SCBPort</span><span class="p">);</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">self_test_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>  <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span>  <span class="o">--</span><span class="n">boguscnt</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">boguscnt</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>        <span class="cm">/* Test optimized out. */</span>             <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Self test failed, status</span>
</span><span class='line'><span class="o">%</span><span class="mf">8.8</span><span class="n">x</span><span class="o">:</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;                 KERN_ERR &quot;</span> <span class="n">Failure</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="n">i82557</span><span class="p">.</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;                 KERN_ERR &quot;</span> <span class="n">Verify</span> <span class="n">that</span> <span class="n">the</span>
</span><span class='line'><span class="o">%</span><span class="n">card</span> <span class="n">is</span> <span class="n">a</span> <span class="n">bus</span><span class="o">-</span><span class="n">master</span><span class="s">&quot;                 &quot;</span> <span class="n">capable</span> <span class="n">slot</span><span class="p">.</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;,                 self_test_results[1]);         } else</span>
</span><span class='line'><span class="o">%</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  General self-test: %s.</span><span class="se">\n</span><span class="s">&quot;</span>                 <span class="n">KERN_INFO</span> <span class="s">&quot;  Serial sub-system self-test: %s.</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="o">%</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Internal registers self-test: %s.</span><span class="se">\n</span><span class="s">&quot;</span>                 <span class="n">KERN_INFO</span> <span class="s">&quot;  ROM checksum self-test: %s (%#8.8x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'><span class="o">%</span><span class="n">self_test_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x1000</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;passed&quot;</span><span class="p">,</span>                 <span class="n">self_test_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x0020</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span>
</span><span class='line'><span class="o">%</span><span class="s">&quot;passed&quot;</span><span class="p">,</span>                 <span class="n">self_test_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x0008</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;passed&quot;</span><span class="p">,</span>                 <span class="n">self_test_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'><span class="o">%&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x0004</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;passed&quot;</span><span class="p">,</span>                 <span class="n">self_test_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>     <span class="p">}</span> <span class="err">#</span><span class="n">endif</span>  <span class="cm">/* kernel_bloat */</span>
</span><span class='line'><span class="o">%</span><span class="n">iowrite32</span><span class="p">(</span><span class="n">PortReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SCBPort</span><span class="p">);</span>     <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SCBPort</span><span class="p">);</span>     <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>     <span class="cm">/* Return the chip to its</span>
</span><span class='line'><span class="cm">%original power state. */</span>     <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">acpi_idle_state</span><span class="p">);</span>     <span class="n">pci_set_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span><span class='line'><span class="o">%</span><span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">irq</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">DEBUG</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">acpi_pwr</span> <span class="o">=</span> <span class="n">acpi_idle_state</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">tx_ring_space</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">tx_ring_dma</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">lstats</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">speedo_stats</span> <span class="o">*</span><span class="p">)(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">TX_RING_SIZE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">lstats_dma</span> <span class="o">=</span> <span class="n">TX_RING_ELEM_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">TX_RING_SIZE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">timer</span><span class="p">);</span> <span class="cm">/* used in ioctl() */</span>
</span><span class='line'>    <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">lock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">option</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">full_duplex</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">card_idx</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">default_port</span> <span class="o">=</span> <span class="n">option</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x1f</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_bug</span> <span class="o">=</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(((</span><span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">device</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mh">0x1030</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">device</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mh">0x103F</span><span class="p">)))</span>          <span class="o">||</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2449</span><span class="p">)</span>
</span><span class='line'><span class="o">||</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2459</span><span class="p">)</span>
</span><span class='line'>            <span class="o">||</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x245D</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_bug</span><span class="p">)</span>
</span><span class='line'>        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Receiver lock-up workaround activated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* The Speedo-specific entries in the device structure. */</span>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">open</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">speedo_open</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">hard_start_xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">speedo_start_xmit</span><span class="p">;</span>
</span><span class='line'>    <span class="n">netif_set_tx_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">speedo_tx_timeout</span><span class="p">,</span> <span class="n">TX_TIMEOUT</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">stop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">speedo_close</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">get_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">speedo_get_stats</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">set_multicast_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">set_rx_mode</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">do_ioctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">speedo_ioctl</span><span class="p">;</span>
</span><span class='line'>    <span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ethtool_ops</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">poll_controller</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">poll_speedo</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">register_netdevice</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">err_free_unlock</span><span class="p">;</span>
</span><span class='line'>    <span class="n">rtnl_unlock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">err_free_unlock:</span>
</span><span class='line'>    <span class="n">rtnl_unlock</span><span class="p">();</span>
</span><span class='line'>    <span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>speedo_found1()</em>: The kernel needs to know that this is an Ethernet device and it can use this new PCI device to
send/receive data over the network. For this, a device specific structure, <em>net_device</em>, is create and registered
<em>register_netdevice()</em>with the kernel. <em>net_device</em> contains the device name, it&#8217;s MAC address, options
like full-duplex, interrupt number (IRQ) &amp; pointers to functions for executing all the device functions.</p>

<p>Every ethernet device found should have a unique name and on linux ethernet devices are named eth0, eth1&#8230;eth100.
<em>dev_alloc_name()</em> allocates a name for this device and sets it in <em>net_device</em> structure.</p>

<p>Every 802.3 device has an unique 48-bit MAC address assigned to it. This address is not hardcoded in 82559, but is
stored by the board manufacturer in a non-volatile form, such as in the EEPROM or Flash EPROM outside 82559.</p>

<p>82559 expects the EEPROM format to be as shown below.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559EEPROMFormat.jpg" width="82559" title="EEPROM Format" ><span class='caption-text'>EEPROM Format</span></span></p>

<p>The 82559 automatically reads five words (0H, 1H, 2H, AH, and DH) from the EEPROM during bootup. The MAC address is
extracted from 0H, 1H &amp; 2H. The rest of the EEPROM map contains device options like type of connector, the device
type, PHY device ID etc.</p>

<p><em>speedo_found1()</em> then proceeds to reset the 82559 chip using the PORT command (writing a zero value to the
SCBport, offset 8 in the CSR). The PORT commands is also used to self-test the 82559.</p>

<p>The kernel also needs to know what functions to call to open the device(<em>speedo_open</em>), transmit
(<em>speedo_start_xmit</em>), close/stop (<em>speedo_stop</em>), get stats (<em>speedo_get_stats</em>), do IOCTL
(<em>speedo_ioctl</em>). Notice that there is no receive function. This is because packets are received asynchronously.
When a new packet is received 82559 interrupts the kernel and the interrupt service routine handles the received packet
(more on this later). At this point the timer routines are also initialized.</p>

<p>This completes the initialization of 82559. The device is now ready to receive &amp; transmitt ethernet frames.</p>

<h3>Assigning an IP address to the device</h3>

<p>After initializing the device, the device should be opened so that it is accessible from the IP layer. The device is
accessible from the outside world when an IP address is assigned to it. One way to assign an IP address to an interface
is throught the ifconfig program available from the net-utils.</p>

<p>The syntax to enable the device is:</p>

<p><em>ifconfig eth0 up</em></p>

<p>When asked to bring up the eth0 interface, ifconfig creates a generic raw TCP socket to the afinet address family and
issues a SIOCSIFFLAG ioctl to this raw socket. The flags set on the interface are the IFF_UP &amp; IFF_RUNNING.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* ifconfig.c */</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">spp</span><span class="p">,</span> <span class="s">&quot;up&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">goterr</span> <span class="o">|=</span> <span class="n">set_flag</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="p">(</span><span class="n">IFF_UP</span> <span class="o">|</span> <span class="n">IFF_RUNNING</span><span class="p">));</span>
</span><span class='line'>            <span class="n">spp</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Set a certain interface flag. */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">set_flag</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flag</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">safe_strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFFLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;%s: unknown interface: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
</span><span class='line'>                <span class="n">ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">safe_strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCSIFFLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;SIOCSIFFLAGS&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The userspace <em>ioctl()</em> system call is transformed to the <em>inet_ioctl()</em> defined in <em>af_inet.c</em>.
For <em>ifconfig</em> (or any interface-type ioctls) <em>inet_ioctl()</em> calls <em>devinet_ioctl()</em> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">devinet_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">sin_orig</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">**</span><span class="n">ifap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">colon</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">tryaddrmatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     *  Fetch the caller&#39;s info block into kernel space</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ifr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">)))</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* save original address for comparison */</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sin_orig</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sin</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">colon</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span>
</span><span class='line'>        <span class="o">*</span><span class="n">colon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">case</span> <span class="n">SIOCSIFADDR</span>:   <span class="cm">/* Set interface address (and family) */</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">SIOCSIFBRDADDR</span>:    <span class="cm">/* Set the broadcast address */</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">SIOCSIFDSTADDR</span>:    <span class="cm">/* Set the destination address */</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">SIOCSIFNETMASK</span>:    <span class="cm">/* Set the netmask for the interface */</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
</span><span class='line'>            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">sin</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">sin_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span>
</span><span class='line'>            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="nl">default:</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">rtnl_lock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span>
</span><span class='line'>        <span class="o">*</span><span class="n">colon</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">tryaddrmatch</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* Matthias Andree */</span>
</span><span class='line'>            <span class="cm">/* compare label and address (4.4BSD style) */</span>
</span><span class='line'>            <span class="cm">/* note: we only do this for a limited set of ioctls</span>
</span><span class='line'><span class="cm">               and only if the original address family was AF_INET.</span>
</span><span class='line'><span class="cm">               This is checked above. */</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">in_dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>                 <span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_label</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">sin_orig</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span>
</span><span class='line'>                            <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_address</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span> <span class="cm">/* found */</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="cm">/* we didn&#39;t get a match, maybe the application is</span>
</span><span class='line'><span class="cm">           4.3BSD-style and passed in junk so we fall back to</span>
</span><span class='line'><span class="cm">           comparing just the label */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">in_dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>                 <span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_next</span><span class="p">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_label</span><span class="p">))</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCSIFADDR</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCSIFFLAGS</span><span class="p">)</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">SIOCSIFADDR</span>:   <span class="cm">/* Set interface address (and family) */</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">inet_abc_len</span><span class="p">(</span><span class="n">sin</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span>           <span class="k">break</span><span class="p">;</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span><span class="p">)</span> <span class="p">{</span>             <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">((</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">inet_alloc_ifa</span><span class="p">())</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>               <span class="k">break</span><span class="p">;</span>          <span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span>              <span class="n">memcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_label</span><span class="p">,</span>
</span><span class='line'><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">memcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_local</span> <span class="o">==</span> <span class="n">sin</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="n">inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_broadcast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_anycast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_address</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_local</span> <span class="o">=</span> <span class="n">sin</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">flags</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">IFF_POINTOPOINT</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="n">inet_abc_len</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_address</span><span class="p">);</span>
</span><span class='line'>            <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_mask</span> <span class="o">=</span> <span class="n">inet_make_mask</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_prefixlen</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">flags</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">IFF_BROADCAST</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span>
</span><span class='line'>                <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_prefixlen</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">31</span><span class="p">)</span>              <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_broadcast</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_address</span> <span class="o">|</span>
</span><span class='line'>                             <span class="o">~</span><span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_mask</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ifa</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">ifa_mask</span> <span class="o">=</span> <span class="n">inet_make_mask</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">inet_set_ifa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="nl">done:</span>
</span><span class='line'>    <span class="n">rtnl_unlock</span><span class="p">();</span>
</span><span class='line'><span class="nl">out:</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="nl">rarok:</span>
</span><span class='line'>    <span class="n">rtnl_unlock</span><span class="p">();</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ifr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>devinet_ioctl()</em> fetches the user space defined <em>ifreq</em> structure containing the name of our interface
and the IP address to the kernel space. Based on the name of the interface (eth0, for e.g.), the device structure,
<em>net_device</em> (remember we created this in speedo_foun1() above?), is looked up [ <em>__dev_get_by_name()</em>].
The IP is set to this device by <em>inet_set_ifa()</em>.</p>

<h3>Shared Memory Communication Architecture</h3>

<p>After initialization, 82559 is ready for its normal operation. As a Fast Ethernet Controller, its normal operation is to
transmit and receive data packets. As a PCI bus master device, 82559 works independently, without CPU intervention. The
CPU provides the 82559 with action commands and pointers to the data buffers that reside in host main memory. The 82559
independently manages these structures and initiates burst memory cycles to transfer data to and from main memory.</p>

<p>The CPU controls and examines 82559 via its control and status structures. Some of these control and status structures
reside within the 82559 and some reside in system memory. For transfer of data to/from the CPU, the 82559 establishes a
shared memory communication with the host CPU. This shared memory is divided into three parts:</p>

<ul>
<li>The Control/Status Registers (CSR)</li>
<li>The Command Block List (CBL) or just Command List (CL)</li>
<li>The Receive Frame Area (RFA).</li>
</ul>


<p>The CSR resides on-chip and can be accessed by either I/O or memory cycles (after the PCI BIOS has mapped this region to
a region accessible by the CPU. See the section PCI Kernel Initialization), while the CBL and RFA reside in system
(host) memory.</p>

<p>Command Block List (CBL) is a linked list of commands to be executed by 82559. Receive Frame Area (RFA) is a linked list
of data structures that holds the received packets (frames).</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559SharedMemoryArchitecture_good.jpg" width="82559" title="Shared Memory Architecture" ><span class='caption-text'>Shared Memory Architecture</span></span></p>

<h4>Controlling 82559 through CSR</h4>


<p>The 82559 has seven Control/Status registers which make up the CSR space.</p>

<p><span class='caption-wrapper'><img class="/images/from-bits-to-waves/82559CSR.jpg 82559" src="Command/Status" title="Registers (CSR)" ><span class='caption-text'>Registers (CSR)</span></span></p>

<p>The first 8 bytes of the CSR is called the System Control Block (SCB). The SCB serves as a central communication point
for exchanging control and status information between the host CPU and the 82559.</p>

<p>The CPU instructs the 82559 to Activate, Suspend, Resume or Idle the Command Unit (CU) or Receive Unit (RU) by placing
the appropriate control command in the CU or RU control field of SCB. Activating the CU causes the 82559 to begin
transmitting packets. When transmission is completed, the 82559 updates the SCB with the CU status then interrupts the
CPU, if configured to do so. Activating the RU causes the 82559 to go into the READY state for frame reception. When a
frame is received the RU updates the SCB with the RU status and interrupts the CPU.</p>

<h3>Command Block List (CBL) and Transmitted Frame</h3>

<p>Transmit or configure commands issued by CPU are wrapped inside what are called Command Blocks (CB). These command
blocks are chained together to form the CBL.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559ActionCommand.jpg" title="Action Command" ><span class='caption-text'>Action Command</span></span></p>

<p>Action commands are categorized into two types:</p>

<ul>
<li>Non-Tx commands: This category includes commands such as NOP, Configure, IA Setup, Multicast Setup, Dump and Diagnose.</li>
<li>Tx command: This command causes the 82559 to transmit a frame. A transmit command block contains (in the parameter
field) the destination address, length of the transmitted frame and a pointer to buffer area in memory containing the
data portion of the frame. The data field is contained in a memory data structure consisting of a buffer descriptor (BD)
and a data buffer, or a linked list of buffer descriptors and buffers (as shown in figure below).</li>
</ul>


<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559DataBuffer.jpg" title="Data buffer" ><span class='caption-text'>Data buffer</span></span></p>

<p>When eepro100 is ready to transmit a packet, it must create this Tx command block and send it to 82559. This Tx Command
block is a structure called TxFD (Transmit Frame Descriptor).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">TxFD</span> <span class="p">{</span>                    <span class="cm">/* Transmit frame descriptor set. */</span>
</span><span class='line'>    <span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>    <span class="n">u32</span> <span class="n">link</span><span class="p">;</span>                    <span class="cm">/* void * */</span>
</span><span class='line'>    <span class="n">u32</span> <span class="n">tx_desc_addr</span><span class="p">;</span>            <span class="cm">/* Always points to the tx_buf_addr element. */</span>
</span><span class='line'>    <span class="n">s32</span> <span class="n">count</span><span class="p">;</span>                    <span class="cm">/* # of TBD (=1), Tx start thresh., etc. */</span>
</span><span class='line'><span class="cp">    /* This constitutes two &quot;TBD&quot; entries -- we only use one. */</span>
</span><span class='line'><span class="cp">#define TX_DESCR_BUF_OFFSET 16</span>
</span><span class='line'>    <span class="n">u32</span> <span class="n">tx_buf_addr0</span><span class="p">;</span>            <span class="cm">/* void *, frame to be transmitted.  */</span>
</span><span class='line'>    <span class="n">s32</span> <span class="n">tx_buf_size0</span><span class="p">;</span>            <span class="cm">/* Length of Tx frame. */</span>
</span><span class='line'>    <span class="n">u32</span> <span class="n">tx_buf_addr1</span><span class="p">;</span>            <span class="cm">/* void *, frame to be transmitted.  */</span>
</span><span class='line'>    <span class="n">s32</span> <span class="n">tx_buf_size1</span><span class="p">;</span>            <span class="cm">/* Length of Tx frame. */</span>
</span><span class='line'>    <span class="cm">/* the structure must have space for at least CONFIG_DATA_SIZE starting</span>
</span><span class='line'><span class="cm">    * from tx_desc_addr field */</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>This TxFD can hold one TxCB and two Tx Buffer Descriptors (TxBD). During eepro100 initialization
(<em>speedo_found1()&lt;/em), a fixed number of these TxFD&#8217;s are created and linked together into a ring
(</em>tx_ring_space*). When new data is available for transmission, one of the TxFD is fetched from the ring and sent
to 82559 for transmission.</p>

<p>The status field of TxFD is a bit array and can contain any of:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Commands that can be put in a command list entry. */</span>
</span><span class='line'><span class="k">enum</span> <span class="n">commands</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CmdNOp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CmdIASetup</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="n">CmdConfigure</span> <span class="o">=</span> <span class="mh">0x20000</span><span class="p">,</span>
</span><span class='line'>    <span class="n">CmdMulticastList</span> <span class="o">=</span> <span class="mh">0x30000</span><span class="p">,</span> <span class="n">CmdTx</span> <span class="o">=</span> <span class="mh">0x40000</span><span class="p">,</span> <span class="n">CmdTDR</span> <span class="o">=</span> <span class="mh">0x50000</span><span class="p">,</span>
</span><span class='line'>    <span class="n">CmdDump</span> <span class="o">=</span> <span class="mh">0x60000</span><span class="p">,</span> <span class="n">CmdDiagnose</span> <span class="o">=</span> <span class="mh">0x70000</span><span class="p">,</span>
</span><span class='line'>    <span class="n">CmdSuspend</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>    <span class="cm">/* Suspend after completion. */</span>
</span><span class='line'>    <span class="n">CmdIntr</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>        <span class="cm">/* Interrupt after completion. */</span>
</span><span class='line'>    <span class="n">CmdTxFlex</span> <span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>        <span class="cm">/* Use &quot;Flexible mode&quot; for CmdTx command. */</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Receive Frame Area</h3>

<p>To reduce CPU overhead, the 82559 is designed to receive frames without CPU supervision. The host CPU first sets aside
an adequate receive buffer space and then enables the 82559 Receive Unit (This is done in <em>speedo_init_rx_ring</em>
when the device is opened: <em>speedo_open</em>). Once enabled, the RU watches for arriving frames and automatically
stores them in the Receive Frame Area (RFA).</p>

<p>The RFA contains Receive Frame Descriptors, Receive Buffer Descriptors, and Receive Buffers (see figure below).</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559FlexibleReceiveStructure1.jpg" title="Flexible Receive Structure" ><span class='caption-text'>Flexible Receive Structure</span></span></p>

<p>The individual Receive Frame Descriptors make up a Receive Descriptor List (RDL) used by the 82559 to store the
destination and source addresses, the length field, and the status of each frame received.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559ReceiveFrameDescriptor.jpg" title="Receive Frame Descriptor" ><span class='caption-text'>Receive Frame Descriptor</span></span></p>

<p>eepro100 representation of the Receive Frame Descriptor (RxFD):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">RxFD</span> <span class="p">{</span>                    <span class="cm">/* Receive frame descriptor. */</span>
</span><span class='line'>    <span class="k">volatile</span> <span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>    <span class="n">u32</span> <span class="n">link</span><span class="p">;</span>                    <span class="cm">/* struct RxFD * */</span>
</span><span class='line'>    <span class="n">u32</span> <span class="n">rx_buf_addr</span><span class="p">;</span>            <span class="cm">/* void * */</span>
</span><span class='line'>    <span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">RxFD_ALIGNMENT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Selected elements of the Tx/RxFD.status word. */</span>
</span><span class='line'><span class="k">enum</span> <span class="n">RxFD_bits</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">RxComplete</span><span class="o">=</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">RxOK</span><span class="o">=</span><span class="mh">0x2000</span><span class="p">,</span>
</span><span class='line'>    <span class="n">RxErrCRC</span><span class="o">=</span><span class="mh">0x0800</span><span class="p">,</span> <span class="n">RxErrAlign</span><span class="o">=</span><span class="mh">0x0400</span><span class="p">,</span> <span class="n">RxErrTooBig</span><span class="o">=</span><span class="mh">0x0200</span><span class="p">,</span> <span class="n">RxErrSymbol</span><span class="o">=</span><span class="mh">0x0010</span><span class="p">,</span>
</span><span class='line'>    <span class="n">RxEth2Type</span><span class="o">=</span><span class="mh">0x0020</span><span class="p">,</span> <span class="n">RxNoMatch</span><span class="o">=</span><span class="mh">0x0004</span><span class="p">,</span> <span class="n">RxNoIAMatch</span><span class="o">=</span><span class="mh">0x0002</span><span class="p">,</span>
</span><span class='line'>    <span class="n">TxUnderrun</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span>  <span class="n">StatusComplete</span><span class="o">=</span><span class="mh">0x8000</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Data Transmission</h2>

<p>An application calls <em>write(socket, data, length)</em> system call to write to an open socket. In the kernel,
<em>inet_sendmsg()</em> is executed with a pointer to the sock structure. <em>inet_sendmsg()</em> calls the send
operation of the corresponding transport protocol which for TCP is <em>tcp_sendmsg()</em>. <em>tcp_sendmsg()</em> copies
the data to be transmitted from the user space to the socket and starts the transmit process by calling
<em>tcp_send_skb()</em> and subsequently <em>tcp_transmitt_skb()</em>. <em>tcp_transmitt_skb()</em> adds the TCP Header
to the packet, calculate the TCP checksum and call the <em>ip_queue_xmit()</em>. Determining the ip route and
construction of the IP header happens in <em>ip_queue_xmit()</em>. Finally the MAC address is copied to the packet and
<em>dev_queue_xmit()</em> is called to send the packet to the ethernet device.</p>

<p><em>dev_queue_xmit()</em> points to a driver specific function. In case of eepro100, this function is
<em>speedo_start_xmit()</em> (remember we set this in <em>speedo_found1()</em>?).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">speedo_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">speedo_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">regs</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Prevent interrupts from changing the Tx ring from underneath us. */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Check if there are enough space. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dirty_tx</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="n">TX_QUEUE_LIMIT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: incorrect tbusy state, fixed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>        <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Calculate the Tx descriptor entry. */</span>
</span><span class='line'>    <span class="n">entry</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">cur_tx</span><span class="o">++</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CmdSuspend</span> <span class="o">|</span> <span class="n">CmdTx</span> <span class="o">|</span> <span class="n">CmdTxFlex</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">((</span><span class="n">TX_RING_SIZE</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>        <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CmdIntr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">link</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TX_RING_ELEM_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">));</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tx_desc_addr</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TX_RING_ELEM_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="o">+</span> <span class="n">TX_DESCR_BUF_OFFSET</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* The data region is always in one buffer descriptor. */</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_threshold</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tx_buf_addr0</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">data</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">skb</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tx_buf_size0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* workaround for hardware bug on 10 mbit half duplex */</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">partner</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">wait_for_cmd_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
</span><span class='line'>        <span class="n">iowrite8</span><span class="p">(</span><span class="mi">0</span> <span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SCBCmd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Trigger the command unit resume. */</span>
</span><span class='line'>    <span class="n">wait_for_cmd_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
</span><span class='line'>    <span class="n">clear_suspend</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">last_cmd</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* We want the time window between clearing suspend flag on the previous</span>
</span><span class='line'><span class="cm">    command and resuming CU to be as small as possible.</span>
</span><span class='line'><span class="cm">    Interrupts in between are very undesired.  --SAW */</span>
</span><span class='line'>    <span class="n">iowrite8</span><span class="p">(</span><span class="n">CUResume</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SCBCmd</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">last_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">descriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Leave room for set_rx_mode(). If there is no more space than reserved</span>
</span><span class='line'><span class="cm">    for multicast filter mark the ring as full. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dirty_tx</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="n">TX_QUEUE_LIMIT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>speedo_start_xmit()</em> inserts any data received from the kernel (skb) into the Tx ring. If there are no open
slots in the Tx ring, <em>netif_stop_queue()</em> is called to request the kernel to stop sending more packets from the
upper layers and flag the Tx ring as full. The new skb (data) to be transmitted is inserted as the data portion of a
TxFD at <em>tx_buf_addr0</em> (See TxFD above).</p>

<p>The TxFD status of this entry is set to <em>CmdSuspend</em> (suspend after completion), <em>CmdTx</em> and
<em>CmdFlex</em> (flexible transmission mode). The last command inserted into the Tx ring has the <em>CmdSuspend</em>
bit set so that the CU is suspended immediately after the last command is executed. This way we prevent any erroneous
data from being transmitted. We have to clear the <em>CmdSuspend</em> from the previous command already in the Tx ring
before doing this. If the Tx ring is more than half full, we also set <em>CmdIntr</em> (interrupt after completion). The
causes the chip to generates an interrupt after executing this command. When an interrupt is received after transmit
completes, the interrupt handler calls <em>speedo_tx_buffer_gc()</em> to clean up completed and erroneous skb from the
Tx ring.</p>

<p>Finally, we activate the CU to transmit this new packet by issuing <em>CmdResume</em> to SCB.</p>

<h3>Generating the Ethernet Frame</h3>

<p>The final ethernet frame sent over the wire is:</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/EthernetFrameFormat.jpg" title="Ethernet Frame Format" ><span class='caption-text'>Ethernet Frame Format</span></span></p>

<p>82559 automatically generates the preamble (alternating 1s and 0s) and start frame delimiter, fetches the destination
address and length field from the Transmit command, inserts its unique MAC address (that it fetched from the external
Flash/EEPROM) as the source address, fetches the data field specified by the Transmit command, and computes and appends
the CRC to the end of the frame.</p>

<p>This final frame is then handed over to the PHY layer for transmission over the wire.</p>

<h3>Bits to Waves</h3>

<p>82559 has an internal 82555 Physical Layer Interface (PHY). It is responsible for connecting the 82559 to the actual
physical wire over which the data will be carried. PHY converts the incoming digital data to analog signals during
transmission and analog signals to digital data during reception.</p>

<h4>Signal Transmission</h4>


<p>To achieve a high transfer rate (upto 125Mbps), two tasks must be performed to the data before it is transmitted over
the wire:</p>

<ul>
<li>scrambling/descrambling</li>
<li>encoding/decoding</li>
</ul>


<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/100BaseTxPHYModule.jpg" title="PHY Module" ><span class='caption-text'>PHY Module</span></span></p>

<h4>Scrambling/Descrambling</h4>


<p>All data transmitted and received over wire are synchronized with a clock. To keep the receiver in sync with the
transmitter, the clock signals have to be embedded in the signal transmitted over the wire itself. The robustness of
this digitally transmitted synchronization signal often depends on the statistical nature of the data being transmitted.
For example, long strings of 0’s and 1’s can cause loss of the synchronization since the receiver clock is derived from
the received data. Therefore, data must contain adequate transitions to assure that the timing recovery circuit at the
receiver will stay in synchronization. Scrambling (randomizing) the data over a period of time spreads these patterns.</p>

<h4>Encoding/Decoding</h4>


<p>There are different ways to represent the digital 1 &amp; 0 over the wire. The most widely used is Non-Return to Zero
(NRZI) format. NRZI, is a two level unipolar code (0 and V) representing a &#8220;one&#8221; by a transition between two levels and
a &#8220;zero&#8221; is represented by no transition as shown in the figure below. Another format is MLT-3. MLT-3 is a three level
eenting a &#8220;one&#8221; by a transition between two levels and &#8220;zero&#8221; as no transition as shown in figure below. MLT-3 has the
advantage that the maximum fundamental frequency of MLT-3 is one-half that of NRZI. With the MLT-3 coding scheme, 90% of
the spectral energy is below 40MHz versus 70MHz for NRZI. Thus we can achieves the same data rate as NRZI, but do not
require a wideband transmission medium. The work of the encoder/decoder is to convert between NRZI and MLT-3.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/BitsOnWire.jpg" title="Bits on Wire" ><span class='caption-text'>Bits on Wire</span></span></p>

<p>Finally, the MLT-3 encoded data is transmitted over the wire. It is important to isolate the the PHY from the CAT-5
Ethernet cable for load balancing and also feedback. This is done by using specialized Ethernet magnetics with each side
of the transformer referenced to the appropriate ground.</p>

<p><span class='caption-wrapper'><img src="http://interviewquestions.pupilgarage.com/images/EC%20Images/EC_Fig03.gif" title="PHY to Magnetics interface" ><span class='caption-text'>PHY to Magnetics interface</span></span></p>

<h4>Signal Reception</h4>


<p>Once the PHY detects signals on the receive side, it decodes and descrambles it to reconstruct the data transmitted by
the receiver.</p>

<h4>Receiving Frames</h4>


<p>To reduce CPU overhead, the 82559 is designed to receive frames without CPU supervision. The eepro100 had already setup
the address of the receive buffer ring in the SCB as part of initialization. Once the 82559 receive unit (RU) is
enabled, the RU watches for arriving frames and automatically stores them in the Rx ring / Receive Frame Area (RFA). The
RFA contains Receive Frame Descriptors, Receive Buffer Descriptors, and Data Buffers (see Figure 2). The individual
Receive Frame Descriptors make up a Receive Descriptor List (RDL) used by the 82559 to store the destination and source
addresses, the length field, and the status of each frame received.</p>

<p><span class='caption-wrapper'><img src="/images/from-bits-to-waves/82559FlexibleReceiveStructure.jpg" title="Flexible Receive Structure" ><span class='caption-text'>Flexible Receive Structure</span></span></p>

<p>82559 checks each passing frame for an address match. The 82559 will recognize its own unique address, one or more
multicast addresses, or the broadcast address. If a match is found, 82559 stores the destination address, source
addresses and the length field in the next available Receive Frame Descriptor (RFD). It then begins filling the next
available Data Buffer on the Receive Buffer Descriptor (RBD). As one Data Buffer is filled, the 82559 automatically
fetches the next Data Buffer &amp; RBD until the entire frame is received.</p>

<p>Once the entire frame is received without error, a frame received interrupt status bit is posted in the SCB and an
interrupt is sent to the CPU.</p>

<p>The interrupt handler (<em>speedo_interrupt()</em>) checks if the receive interrupt bit is set in SCB and calls
<em>speedo_rx()</em> to handle the received packet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">speedo_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">speedo_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">rx_work_limit</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dirty_rx</span> <span class="o">+</span> <span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">cur_rx</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">alloc_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">npkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
</span><span class='line'>        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; In speedo_rx().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* If we own the next entry, it&#39;s a new packet. Send it up. */</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ringp</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ring_dma</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
</span><span class='line'>                                    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ringp</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">status</span><span class="p">);</span>
</span><span class='line'>        <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ringp</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0x3fff</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">RxComplete</span><span class="p">))</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">rx_work_limit</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span>             <span class="k">break</span><span class="p">;</span>         <span class="cm">/* Check for a rare out-of-memory case: the current</span>
</span><span class='line'><span class="cm">buffer is         the last buffer allocated in the RX ring.  --SAW */</span>         <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">last_rxf</span> <span class="o">==</span>
</span><span class='line'><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ringp</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* Postpone the packet.  It&#39;ll be reaped at an interrupt when this</span>
</span><span class='line'><span class="cm">            packet is no longer the last packet in the ring. */</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
</span><span class='line'>                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX packet postponed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>            <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ring_state</span> <span class="o">|=</span> <span class="n">RrPostponed</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
</span><span class='line'>            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  speedo_rx() status %8.8x len %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
</span><span class='line'>                <span class="n">pkt_len</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">RxErrTooBig</span><span class="o">|</span><span class="n">RxOK</span><span class="o">|</span><span class="mh">0x0f90</span><span class="p">))</span> <span class="o">!=</span> <span class="n">RxOK</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">RxErrTooBig</span><span class="p">)</span>
</span><span class='line'>                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Ethernet frame overran the Rx buffer, &quot;</span>
</span><span class='line'>                    <span class="s">&quot;status %8.8x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">RxOK</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* There was a fatal error.  This *should* be impossible. */</span>
</span><span class='line'>                <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Anomalous event in speedo_rx(), &quot;</span>
</span><span class='line'>                    <span class="s">&quot;status %8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="cm">/* Check if the packet is long enough to just accept without</span>
</span><span class='line'><span class="cm">            copying to a properly sized skbuff. */</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">rx_copybreak</span>                 <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="n">skb</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
</span><span class='line'>                <span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>    <span class="cm">/* Align IP on 16 byte boundaries */</span>
</span><span class='line'>                <span class="cm">/* &#39;skb_put()&#39; points to the start of sk_buff data area. */</span>
</span><span class='line'>                <span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ring_dma</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
</span><span class='line'>                                            <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">)</span> <span class="o">+</span> <span class="n">pkt_len</span><span class="p">,</span>
</span><span class='line'>                                            <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if 1 || USE_IP_CSUM</span>
</span><span class='line'>                <span class="cm">/* Packet is in one chunk -- we can copy + cksum. */</span>
</span><span class='line'>                <span class="n">eth_copy_and_sum</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tail</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>                <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>                <span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">tail</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">pkt_len</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>                <span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ring_dma</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
</span><span class='line'>                                            <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">)</span> <span class="o">+</span> <span class="n">pkt_len</span><span class="p">,</span>
</span><span class='line'>                                            <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
</span><span class='line'>                <span class="n">npkts</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* Pass up the already-filled skbuff. */</span>
</span><span class='line'>                <span class="n">skb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Inconsistent Rx descriptor chain.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>                <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
</span><span class='line'>                <span class="n">npkts</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ringp</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>                <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ring_dma</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
</span><span class='line'>                                <span class="n">PKT_BUF_SZ</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">),</span>
</span><span class='line'>                                <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">skb</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span><span class='line'>            <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span><span class='line'>            <span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
</span><span class='line'>            <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
</span><span class='line'>        <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">rx_ring_state</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">=</span> <span class="o">~</span><span class="n">RrPostponed</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/* Refill the recently taken buffers.</span>
</span><span class='line'><span class="cm">        Do it one-by-one to handle traffic bursts better. */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">alloc_ok</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">speedo_refill_rx_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="n">alloc_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Try hard to refill the recently taken buffers. */</span>
</span><span class='line'>    <span class="n">speedo_refill_rx_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">npkts</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sp</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">last_rx_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The receive is a very simple process as most of the work is handled by the 82559 chip. 82559 while storing the packet on
the Rx ring has already determined the size of the packet, it stores this along with other relevent information like the
receive status in the Rx buffer. <em>speedo_rx()</em> checks the status to make sure there were no errors in receiving
the frame.</p>

<p>The driver receives packets into full-sized buffers - 1560 bytes. When a packet comes in, the driver needs to make a
decision. Does it use the whole 1560 bytes for this packet, or does it allocate a smaller buffer on-the-fly and copy the
data into it? If the size of the frame received is smaller than the <em>rx_copybreak</em>, then a new buffer is
allocated and the data is copied into it. If the packet is larger than <em>rx_copybreak</em>, we remove the received
skbuff (leaving a hole in the Rx ring) and pass this buffer to the higher applications. We later call
<em>speedo_refill_rx_buffers()</em> to refill the hole in the Rx ring.</p>

<p>The type of protocol of this packet is determined by calling <em>eth_type_trans()</em>. The packet is then queued for
the upper layers to process using the <em>netif_rx()</em>. Finally we refill the buffer we just took out of the Rx ring.</p>

<h3>References</h3>

<ul>
<li><a href="http://pcmcia-cs.sourceforge.net/specs/i82555.pdf" title="Intel 82555" target="_blank">Intel 82555 10/100
Mbps LAN Physical Layer Interface</a></li>
<li><a href="http://www.intel.com/content/www/us/en/ethernet-controllers/82559er-fast-ethernet-pci-datasheet.html"
title="Intel 82559 Fast Ethernet Controller Datasheet" target="_blank">Intel 82559 Fast Ethernet PCI Controller Data
Sheet</a></li>
<li><a href="http://www.intel.com/content/www/us/en/ethernet-controllers/8255x-10-100-mbps-ethernet-controller-software-dev-manual.html"
title="Intel 8255X 10/100 Mbps Ethernet Controller Family Open Source Manual " target="_blank">Intel 8255X 10/100 Mbps
Ethernet Controller Family Open Source Manual </a></li>
<li><a href="http://lxr.linux.no/#linux-bk+v2.6.11.5/drivers/net/eepro100.c" title="eepro100.c Linux Device Driver"
target="_blank">eepro100.c Linux Device Driver</a></li>
</ul>

</div>

  <footer>
    <p class="meta">
        <a class="basic-alignment left" href="/" title="Back to Blog">←&nbsp; Back to blog</a>
    </p>
    </footer>

</article>
<comments>
  
  <div id="disqus_thread" aria-live="polite">

<script type="text/javascript">
      var disqus_shortname = 'reasonvalley';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://solomo.github.com/blog/2012/05/09/from-bits-to-waves-the-inner-workings-of-an-ethernet-controller/';
        var disqus_url = 'http://solomo.github.com/blog/2012/05/09/from-bits-to-waves-the-inner-workings-of-an-ethernet-controller/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>

</div>
  
</comments>

        </article><!-- #post-## -->
        </section><!-- #main -->
    </div><!-- #wrap -->
</body>
</html>
